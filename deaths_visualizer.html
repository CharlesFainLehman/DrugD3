
<html>
<head>
    <title>Visualize Drug OD Deaths</title>
	<style>
		div, p, .text, .graph_axis { font: 12px sans-serif; align: center; }
		.line-chart { border: 0px solid gray; }
	</style>
	<script src='https://d3js.org/d3.v4.min.js'></script>
	<script src="https://unpkg.com/d3-simple-slider"></script> <!-- John Walley's d3-simple-slider: https://github.com/johnwalley/d3-simple-slider-->
</head>
<body>
ASDF
<div>
	<svg id = "chart"></svg>
</div>
<div id = 'slider'></div>
JKJL
</body>

<script>
	
	//size of the chart
	var margin = {top: 20, right: 20, bottom: 50, left: 50, axis: 40},
    width = 690 - margin.left - margin.right,
    height = 440 - margin.top - margin.bottom,
	//the chart
	svg = d3.select('#chart')
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	.attr('class', 'line-chart')
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
	//Go fetch the csv. Because this is asynchronous, we can't extract the data (I think?), so we just run everything inside the loop.
	d3.csv("https://raw.githubusercontent.com/CharlesFainLehman/DrugD3/master/data/deaths.csv", function(d) {
	  return {
	    year : +d.year,
	    age : +d.age,
	    rate : +d.rate,
	  };
	}, function(data) {
		
		var ageRange = d3.extent(data, function(d){return d.age}),
		rateMax = d3.max(data, function(d){return d.rate}),
		minYear = d3.min(data, function(d){return d.year}),
		maxYear = d3.max(data, function(d){return d.year});
		
		//set up initial chart
		updateTitle(minYear);
		setUpAxes(ageRange, rateMax);
		MakeDeathChart(data, rateMax, minYear);
		
		//set up slider
		var slider = d3.sliderBottom()
	    .step(1)
		.min(minYear)
		.max(maxYear)
	    .width(width)
	    .displayValue(false)
		.tickFormat(d3.format('.0f'));	
		
		//render
		d3.select("#slider")
		.append("svg")
		.attr("width", width + 175)//I think 175 is needed for outer edges in John's set up. ¯\_(ツ)_/¯
		.attr("height", 50)
		.append("g")
		.attr("transform", "translate(" + (margin.left) + ",10)")
		.call(slider);
		
		//update with slider
	    slider.on('onchange', val => {
			MakeDeathChart(data, rateMax, val);
			updateTitle(val);
			setUpAxes(ageRange, rateMax);
	    })
	});
	
	//And here are the functions
	function MakeDeathChart(dataset, maxHeight, currentYear) {
		var currentYearData = [];
		for (var i = 0; i < dataset.length; i++) { if(dataset[i]["year"] == currentYear) { currentYearData.push(dataset[i]) }}
		var barWidth = (width/currentYearData.length);
		
		//clear the old bars, set up the new one.
		svg.selectAll("rect").remove();
		var barChart = svg.selectAll('rect');
		
		barChart.data(currentYearData)
		.enter()
		.append("rect")
		.attr('y', function(d){
			return height - d['rate'] * (height/maxHeight);
		})
		.attr("height", function(d) {
		    return d['rate'] * (height/maxHeight);
		})
		.attr("width", barWidth)
		.attr("transform", function (d,i) {
		     var translate = barWidth * i;
		     return "translate("+ translate +")";
		})
		.style('fill', '#FC3803');		
	}
	
	function setUpAxes(ageRange, rateMax){
		d3.selectAll('.graph_axis').remove();

		//x axis
		var x = d3.scaleLinear().range([0, width]).domain(ageRange);
		svg.append("g")
        .attr("transform", "translate(0," + height + ")")
		.attr('class', 'graph_axis')
        .call(d3.axisBottom(x));
		
		//x axis label
		svg.append("text")             
        .attr("transform",
              "translate(" + (width/2) + " ," + 
                             (height + margin.axis) + ")")
		.attr('class', 'graph_axis')
		.style("text-anchor", "middle")
        .text("Age");
		
		//y axis
		var y = d3.scaleLinear().range([height, 0]).domain([0, rateMax]);
		svg.append("g")
		.attr('class', 'graph_axis')
		.call(d3.axisLeft(y));
		
		//y axis label
		svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.axis)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
		.attr('class', 'graph_axis')
        .style("text-anchor", "middle")
        .text("Drug Overdose Deaths per 100,000 pop.");
	}
		
	function updateTitle(year){
		//title
		svg.select('#title').remove();
		svg.append("text")
        .attr("x", 20)             
        .attr("y", -10)
		.attr('id', 'title')
		.attr('class', 'text')
        .text("Drug Overdose Deaths by Age Group (" + year + ")");
	}
</script>

</html>